# API Penetration Test – Findings Summary

Findings from a security review of the MobCentra API, with current status after remediation.

**Last updated:** February 2026

---

## Critical

### 1. Authentication Disabled / Not Enforced — **FIXED**
- **Was:** JWT commented out; `[Authorize]` commented on BaseController.
- **Now:** JWT Bearer enabled in `Program.cs` with `Jwt:Key`; `[Authorize]` applied on `BaseController`. Login, reset-password, and refresh-token use `[AllowAnonymous]`.
- **Status:** ✅ Resolved.

### 2. Backdoor in Login — **FIXED**
- **Was:** `version == 1993` bypassed password check.
- **Now:** No bypass; `LoginAsync(userName, password, companyCode)` only; POST with `UserLoginRequestDto`.
- **Status:** ✅ Resolved.

### 3. Insecure Direct Object Reference (IDOR) – Password Change — **FIXED**
- **Was:** Any caller could change any user’s password.
- **Now:** `UpdatePasswordAsync(currentUserId, userId, newPassword)` – caller must be the same user or have `EditUsers` permission. Controller passes `identityManager.CurrentUserId`.
- **Status:** ✅ Resolved.

### 4. Credentials in URL — **FIXED**
- **Was:** Login, reset, update-password used GET with credentials in path/query.
- **Now:** All use POST with JSON body: `UserLoginRequestDto`, `ResetPasswordRequestDto`, `UpdatePasswordRequestDto`. No credentials in URL.
- **Status:** ✅ Resolved.

### 5. SQL Injection Risk (Raw Query Pattern) — **FIXED**
- **Was:** `BaseDal.IsAuthorizedAsync` used string-interpolated SQL.
- **Now:** Uses `IAuthorizationChecker.HasPermissionAsync(userId, privilegeId)` implemented with EF Core LINQ (no raw SQL). Raw `ExecuteSQL`/`ExecuteAsync`/`ExecuteCommandAsync` remain in the codebase; ensure no user-controlled input is ever passed into them.
- **Status:** ✅ Resolved for authorization path. ⚠️ Avoid passing user input into raw SQL elsewhere.

---

## High

### 6. Exception Handler Always Returns 200 OK — **FIXED**
- **Was:** All errors returned 200 OK; risk of leaking internal details.
- **Now:** Exception handler maps `UnauthorizedAccessException` → 401, `KeyNotFoundException`/`FileNotFoundException` → 404, `ArgumentException`/`InvalidOperationException` → 400, others → 500. Generic message for 500 ("An error occurred.").
- **Status:** ✅ Resolved.

### 7. Unauthenticated Password Reset — **PARTIALLY ADDRESSED**
- **Current:** Reset-password is unauthenticated by design (forgot-password flow). Global rate limiting applies (e.g. 20 requests per 15 minutes per client).
- **Recommendation:** Consider a stricter rate limit or dedicated policy for login and reset-password to reduce brute-force and abuse. Use same error message for invalid username/company to avoid user enumeration.
- **Status:** ⚠️ By design; rate limiting in place; optional hardening as above.

### 8. Delete Implemented as GET — **FIXED**
- **Was:** `[HttpGet] [Route("delete/{id}")]`.
- **Now:** `[HttpDelete] [Route("{id}")]` in `BaseController`. Clients must use `DELETE /api/controller/{id}`.
- **Status:** ✅ Resolved.

### 9. No Request Body / Input Size Limits (DoS) — **FIXED**
- **Was:** `MaxRequestBodySize = null`; form limits at `int.MaxValue`.
- **Now:** `MaxRequestBodySize = 50 * 1024 * 1024` (50 MB); `FormOptions` value and multipart limits set to 50 MB; `MemoryBufferThreshold` 1 MB.
- **Note:** `[DisableRequestSizeLimit]` on BaseController add/update/range re-enables unlimited size for those actions; consider removing if 50 MB global limit is sufficient.
- **Status:** ✅ Resolved at app level.

---

## Medium

### 10. CORS Misconfiguration — **FIXED**
- **Was:** Trailing space in origin; `AddCors` registered twice.
- **Now:** Single CORS policy with `https://mobcentra.com`, `http://mobcentra.com`, `http://localhost:4200`, `https://localhost:4200`; no duplicate registration.
- **Status:** ✅ Resolved.

### 11. No Input Validation on DTOs — **PARTIALLY FIXED**
- **Now:** `UserLoginRequestDto`, `ResetPasswordRequestDto`, `UpdatePasswordRequestDto` use `[Required]`, `[StringLength]` (and min length on password where applicable).
- **Recommendation:** Add validation (data annotations or FluentValidation) to other API DTOs as they are used; prevent mass assignment on sensitive entities.
- **Status:** ✅ For auth-related DTOs; ⚠️ Extend to rest of API over time.

### 12. Authorization Bypass When `CurrentUserId` Is Empty — **FIXED**
- **Was:** `IsAuthorizedAsync` returned `true` when `CurrentUserId` was default.
- **Now:** Returns `false` when `CurrentUserId` is default or when `TId` is not `Guid`; otherwise uses `IAuthorizationChecker.HasPermissionAsync`.
- **Status:** ✅ Resolved.

---

## Low / Hardening

### 13. Security Headers — **IN PLACE**
- X-Content-Type-Options: nosniff  
- X-Frame-Options: DENY (clickjacking)  
- X-XSS-Protection: 1; mode=block  
- Referrer-Policy: no-referrer  
- **Optional:** Content-Security-Policy if you serve HTML.

### 14. Rate Limiting — **IN PLACE**
- Fixed-window limiter applied to API (e.g. 20 requests per 15 minutes per client). Consider tighter limits for login/reset if needed.

### 15. Sensitive Data in Responses
- Audit DTOs (e.g. `UsersDto`) to ensure password hashes and unneeded internal IDs are not returned. Login returns `token` and `refreshToken` only as designed.

### 16. HSTS — **CONFIGURED**
- `UseHsts()` is called only when `!app.Environment.IsDevelopment()`.

### 17. Token Refresh — **IN PLACE**
- POST `/api/User/refresh-token` with `[AllowAnonymous]`; accepts expired access token or refresh token in `Authorization: Bearer <token>`; returns new `token` and `refreshToken`. JWT access/refresh lifetimes configured in `AuthenticationManager`.

---

## Quick Fix Checklist (Current Status)

| # | Item | Status |
|---|------|--------|
| 1 | Enable JWT and `[Authorize]`; `[AllowAnonymous]` only where needed | ✅ Done |
| 2 | Remove login bypass; POST login with body | ✅ Done |
| 3 | Restrict `UpdatePasswordAsync` to same user or admin; POST body | ✅ Done |
| 4 | Move login, reset-password, update-password to POST with body | ✅ Done |
| 5 | Replace raw SQL in `IsAuthorizedAsync` with parameterized/EF | ✅ Done |
| 6 | Correct HTTP status codes in exception handler; no internal leak | ✅ Done |
| 7 | Delete as `HttpDelete` and route `{id}` | ✅ Done |
| 8 | Set `MaxRequestBodySize` and form limits | ✅ Done (50 MB) |
| 9 | Fix CORS (no trailing space; single policy) | ✅ Done |
| 10 | Add validation on auth DTOs | ✅ Done |
| 11 | In `IsAuthorizedAsync`, treat no user as unauthorized | ✅ Done |
| 12 | Optional: Stricter rate limit for login/reset | ⚠️ Consider |
| 13 | Optional: Remove `[DisableRequestSizeLimit]` on add/update if 50 MB is enough | ⚠️ Consider |

---

## Summary

- **Critical and High** items from the original review have been addressed (auth, backdoor, IDOR, credentials in URL, SQL pattern for auth, exception handling, delete method, request size, CORS).
- **Medium** items are fixed (CORS, auth DTO validation, no-user = unauthorized); extending validation to other DTOs is recommended.
- **Low / Hardening** (headers, rate limit, HSTS, token refresh) are in place; optional improvements are noted above.

For any new endpoints or DTOs, continue to: use POST and body for sensitive data, validate input, enforce authorization, and avoid raw SQL with user input.
